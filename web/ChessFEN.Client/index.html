<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chess FEN Scanner</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ôî</text></svg>">
    <link rel="stylesheet" href="styles.css?v=19">
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <h1>‚ôî Chess FEN Scanner</h1>
        </header>

        <!-- Main Content -->
        <main class="main">
            <!-- Image Input -->
            <section class="card card-compact" id="inputSection">
                <div class="input-options">
                    <button class="btn btn-primary" id="cameraBtn">
                        üì∏ Camera
                    </button>
                    <span class="or-divider">or</span>
                    <label class="btn btn-secondary file-label">
                        üìÅ File
                        <input type="file" id="fileInput" accept="image/*" hidden>
                    </label>
                </div>
                <!-- Skip Detection Option -->
                <div class="skip-detection-row" id="optionsPanel">
                    <label class="checkbox-label">
                        <input type="checkbox" id="skipDetection">
                        <span>Skip board detection</span>
                    </label>
                    <small class="help-text">Use if auto-detection fails on a cropped board image</small>
                </div>
            </section>

            <!-- Loading State -->
            <section class="card loading-card" id="loadingSection" hidden>
                <div class="loading-preview">
                    <img id="loadingPreviewImage" class="loading-preview-image" alt="Analyzing...">
                </div>
                <div class="loading-info">
                    <div class="spinner"></div>
                    <p id="loadingStatus">Analyzing board...</p>
                    <div class="progress-stages" id="progressStages">
                        <span class="stage active" data-stage="detect">üîç Detecting</span>
                        <span class="stage" data-stage="warp">üìê Warping</span>
                        <span class="stage" data-stage="classify">‚ôüÔ∏è Classifying</span>
                        <span class="stage" data-stage="validate">‚úì Validating</span>
                    </div>
                </div>
            </section>

            <!-- Results -->
            <section class="card" id="resultsSection" hidden>
                <!-- Position Status -->
                <div class="fen-container">
                    <div class="fen-status" id="fenStatus"></div>
                    <p class="fen-hint" id="fenHint" hidden>Inspect the board and edit if needed</p>
                </div>

                <!-- Reference Image (shown in edit mode, above the board) -->
                <div class="captured-board-reference" id="capturedBoardReference" hidden>
                    <h4>Reference Image</h4>
                    <img id="capturedBoardImage" class="captured-board-image" alt="Captured board">
                </div>

                <!-- Board Display -->
                <div class="predicted-board-container">
                    <div class="board-wrapper">
                        <table class="chess-board" id="chessBoard"></table>
                    </div>
                    <div class="board-actions" id="boardActions">
                        <button class="btn btn-sm btn-outline" id="editBoardBtn" title="Edit position">‚úèÔ∏è Edit position</button>
                    </div>
                </div>

                <!-- Edit Mode Controls (below the board) -->
                <div class="edit-mode-controls" id="editModeControls" hidden>
                    <!-- Piece Palette -->
                    <div class="piece-palette" id="piecePalette">
                        <div class="palette-row">
                            <span class="palette-piece" data-piece="wK">‚ôî</span>
                            <span class="palette-piece" data-piece="wQ">‚ôï</span>
                            <span class="palette-piece" data-piece="wR">‚ôñ</span>
                            <span class="palette-piece" data-piece="wB">‚ôó</span>
                            <span class="palette-piece" data-piece="wN">‚ôò</span>
                            <span class="palette-piece" data-piece="wP">‚ôô</span>
                        </div>
                        <div class="palette-row">
                            <span class="palette-piece" data-piece="bK">‚ôö</span>
                            <span class="palette-piece" data-piece="bQ">‚ôõ</span>
                            <span class="palette-piece" data-piece="bR">‚ôú</span>
                            <span class="palette-piece" data-piece="bB">‚ôù</span>
                            <span class="palette-piece" data-piece="bN">‚ôû</span>
                            <span class="palette-piece" data-piece="bP">‚ôü</span>
                        </div>
                        <div class="palette-row">
                            <span class="palette-piece selected" data-piece="empty">‚¨ú</span>
                            <span class="palette-hint">Click piece, then click square</span>
                        </div>
                    </div>

                    <!-- Edit Actions -->
                    <div class="edit-actions">
                        <button class="btn btn-sm btn-outline" id="resetBoardBtn" title="Reset to original">‚Ü©Ô∏è Reset</button>
                        <button class="btn btn-sm btn-primary" id="doneEditingBtn">‚úì Done</button>
                    </div>
                </div>

                <!-- Analyze on Chess.com -->
                <div class="search-section">
                    <h3>‚ôüÔ∏è Analyze on Chess.com</h3>
                    <div class="search-buttons">
                        <a class="btn btn-analyze" id="analyzeWhiteBtn" target="_blank">
                            ‚¨ú White to Move
                        </a>
                        <a class="btn btn-analyze" id="analyzeBlackBtn" target="_blank">
                            ‚¨õ Black to Move
                        </a>
                    </div>
                </div>

                <!-- Play on Lichess -->
                <div class="search-section">
                    <h3>‚ôû Lichess: Play vs Computer</h3>
                    <div class="search-buttons">
                        <a class="btn btn-lichess" id="playLichessBtn" target="_blank">
                            Open in Lichess
                        </a>
                    </div>
                </div>

                <!-- Chess.com Search -->
                <div class="search-section" id="findGamesSection">
                    <h3>üîç Find Games on Chess.com</h3>
                    <div class="games-check-row">
                        <button class="btn btn-primary" id="checkGamesBtn">üîç Search</button>
                        <div class="games-check-status" id="gamesCheckStatus" hidden>
                            <span class="checking-text">‚è≥ Checking...</span>
                        </div>
                        <div class="games-found-icons" id="gamesFoundIcons" hidden>
                            <a class="game-found-icon white" id="whiteGameIcon" target="_blank" title="Games found with White to move">
                                <span class="icon">‚ôî</span>
                                <span class="label">White</span>
                            </a>
                            <a class="game-found-icon black" id="blackGameIcon" target="_blank" title="Games found with Black to move">
                                <span class="icon">‚ôö</span>
                                <span class="label">Black</span>
                            </a>
                        </div>
                        <div class="no-games-found" id="noGamesFound" hidden>
                            <span>No games found</span>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="result-actions">
                    <button class="btn btn-secondary" id="newScanBtn">
                        üîÑ New Scan
                    </button>
                </div>
            </section>

            <!-- Error State -->
            <section class="card error-card" id="errorSection" hidden>
                <div class="error-icon">‚ö†Ô∏è</div>
                <p id="errorMessage">An error occurred</p>
                <button class="btn btn-secondary" id="retryBtn">Try Again</button>
            </section>
        </main>

        <!-- Camera Modal -->
        <div class="modal" id="cameraModal" hidden>
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üì∏ Capture Chess Board</h3>
                    <button class="btn btn-icon modal-close" id="closeCameraBtn">‚úï</button>
                </div>
                <div class="camera-container">
                    <video id="cameraVideo" autoplay playsinline muted></video>
                    <div class="camera-guide">
                        <div class="guide-square"></div>
                        <div class="guide-text">Align board here<br><small>Hold steady, good lighting for best results</small></div>
                    </div>
                </div>
                <div class="camera-status" id="cameraStatus">Initializing camera...</div>
                <div class="camera-controls">
                    <button class="btn btn-secondary" id="switchCameraBtn">üîÑ Switch</button>
                    <button class="btn btn-success btn-large" id="captureBtn" disabled>üì∑ Capture</button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div class="toast" id="toast" hidden></div>

        <!-- FAQ Section -->
        <section class="card faq-section">
            <h3>FAQ</h3>
            <details>
                <summary>I get "board not detected"</summary>
                <p>Make sure the lighting is good and the image is as sharp as possible. If it still doesn't work, try cropping the image along the edges of the board and select "Skip board detection".</p>
            </details>
            <details>
                <summary>I get question marks on the resulting board</summary>
                <p>Question marks indicate uncertain predictions. Check against your image and edit the board if needed.</p>
            </details>
            <details>
                <summary>The game does not exist on Chess.com</summary>
                <p>Some games are not uploaded to Chess.com, though most should be available.</p>
            </details>
            <details>
                <summary>Why can I analyze or play as both white and black?</summary>
                <p>The position comes with whose turn it is, but sometimes playing from the other side can be a learning experience as well.</p>
            </details>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <div class="version-info" id="versionInfo">Loading version...</div>
            <a href="admin.html" class="admin-link" id="adminLink" style="display: none;">Admin Dashboard</a>
        </footer>
    </div>

    <script src="config.js?v=18"></script>
    <script src="app.js?v=18"></script>
</body>
</html>
